let defaultParams = `0 /musicscale/Common_Parameters/12_Note_Scale/Dha/0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Dha/Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Dha/Ending_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Dha/Ending_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Dha/Gamaka
3.5 /musicscale/Common_Parameters/12_Note_Scale/Dha/Number
17 /musicscale/Common_Parameters/12_Note_Scale/Dha/Rate
0 /musicscale/Common_Parameters/12_Note_Scale/Dha/Play
0 /musicscale/Common_Parameters/12_Note_Scale/Dha/Pluck
0 /musicscale/Common_Parameters/12_Note_Scale/Dha/Starting_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Dha/Starting_Cent
2 /musicscale/Common_Parameters/12_Note_Scale/Dha/Variance
0 /musicscale/Common_Parameters/12_Note_Scale/Ga/0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Ga/Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Ga/Ending_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Ga/Ending_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Ga/Gamaka
3.5 /musicscale/Common_Parameters/12_Note_Scale/Ga/Number
17 /musicscale/Common_Parameters/12_Note_Scale/Ga/Rate
0 /musicscale/Common_Parameters/12_Note_Scale/Ga/Play
0 /musicscale/Common_Parameters/12_Note_Scale/Ga/Pluck
0 /musicscale/Common_Parameters/12_Note_Scale/Ga/Starting_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Ga/Starting_Cent
2 /musicscale/Common_Parameters/12_Note_Scale/Ga/Variance
0 /musicscale/Common_Parameters/12_Note_Scale/Ma/0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Ma/Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Ma/Ending_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Ma/Ending_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Ma/Gamaka
3.5 /musicscale/Common_Parameters/12_Note_Scale/Ma/Number
17 /musicscale/Common_Parameters/12_Note_Scale/Ma/Rate
0 /musicscale/Common_Parameters/12_Note_Scale/Ma/Play
0 /musicscale/Common_Parameters/12_Note_Scale/Ma/Pluck
0 /musicscale/Common_Parameters/12_Note_Scale/Ma/Starting_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Ma/Starting_Cent
2 /musicscale/Common_Parameters/12_Note_Scale/Ma/Variance
0 /musicscale/Common_Parameters/12_Note_Scale/Ni/0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Ni/Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Ni/Ending_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Ni/Ending_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Ni/Gamaka
3.5 /musicscale/Common_Parameters/12_Note_Scale/Ni/Number
17 /musicscale/Common_Parameters/12_Note_Scale/Ni/Rate
0 /musicscale/Common_Parameters/12_Note_Scale/Ni/Play
0 /musicscale/Common_Parameters/12_Note_Scale/Ni/Pluck
0 /musicscale/Common_Parameters/12_Note_Scale/Ni/Starting_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Ni/Starting_Cent
2 /musicscale/Common_Parameters/12_Note_Scale/Ni/Variance
0 /musicscale/Common_Parameters/12_Note_Scale/Pa/0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Pa/Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Pa/Ending_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Pa/Ending_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Pa/Gamaka
3.5 /musicscale/Common_Parameters/12_Note_Scale/Pa/Number
17 /musicscale/Common_Parameters/12_Note_Scale/Pa/Rate
0 /musicscale/Common_Parameters/12_Note_Scale/Pa/Play
0 /musicscale/Common_Parameters/12_Note_Scale/Pa/Pluck
0 /musicscale/Common_Parameters/12_Note_Scale/Pa/Starting_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Pa/Starting_Cent
2 /musicscale/Common_Parameters/12_Note_Scale/Pa/Variance
0 /musicscale/Common_Parameters/12_Note_Scale/Re/0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Re/Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Re/Ending_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Re/Ending_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Re/Gamaka
3.5 /musicscale/Common_Parameters/12_Note_Scale/Re/Number
17 /musicscale/Common_Parameters/12_Note_Scale/Re/Rate
0 /musicscale/Common_Parameters/12_Note_Scale/Re/Play
0 /musicscale/Common_Parameters/12_Note_Scale/Re/Pluck
0 /musicscale/Common_Parameters/12_Note_Scale/Re/Starting_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Re/Starting_Cent
2 /musicscale/Common_Parameters/12_Note_Scale/Re/Variance
0 /musicscale/Common_Parameters/12_Note_Scale/SA/0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/SA/Cent
0 /musicscale/Common_Parameters/12_Note_Scale/SA/Ending_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/SA/Ending_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/SA/Gamaka
3.5 /musicscale/Common_Parameters/12_Note_Scale/SA/Number
17 /musicscale/Common_Parameters/12_Note_Scale/SA/Rate
0 /musicscale/Common_Parameters/12_Note_Scale/SA/Play
0 /musicscale/Common_Parameters/12_Note_Scale/SA/Pluck
0 /musicscale/Common_Parameters/12_Note_Scale/SA/Starting_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/SA/Starting_Cent
2 /musicscale/Common_Parameters/12_Note_Scale/SA/Variance
0 /musicscale/Common_Parameters/12_Note_Scale/Sa/0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Sa/Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Sa/Ending_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Sa/Ending_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Sa/Gamaka
3.5 /musicscale/Common_Parameters/12_Note_Scale/Sa/Number
17 /musicscale/Common_Parameters/12_Note_Scale/Sa/Rate
0 /musicscale/Common_Parameters/12_Note_Scale/Sa/Play
0 /musicscale/Common_Parameters/12_Note_Scale/Sa/Pluck
0 /musicscale/Common_Parameters/12_Note_Scale/Sa/Starting_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/Sa/Starting_Cent
2 /musicscale/Common_Parameters/12_Note_Scale/Sa/Variance
0 /musicscale/Common_Parameters/12_Note_Scale/dha/0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/dha/Cent
0 /musicscale/Common_Parameters/12_Note_Scale/dha/Ending_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/dha/Ending_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/dha/Gamaka
3.5 /musicscale/Common_Parameters/12_Note_Scale/dha/Number
17 /musicscale/Common_Parameters/12_Note_Scale/dha/Rate
0 /musicscale/Common_Parameters/12_Note_Scale/dha/Play
0 /musicscale/Common_Parameters/12_Note_Scale/dha/Pluck
0 /musicscale/Common_Parameters/12_Note_Scale/dha/Starting_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/dha/Starting_Cent
2 /musicscale/Common_Parameters/12_Note_Scale/dha/Variance
0 /musicscale/Common_Parameters/12_Note_Scale/ga/0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/ga/Cent
0 /musicscale/Common_Parameters/12_Note_Scale/ga/Ending_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/ga/Ending_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/ga/Gamaka
3.5 /musicscale/Common_Parameters/12_Note_Scale/ga/Number
17 /musicscale/Common_Parameters/12_Note_Scale/ga/Rate
0 /musicscale/Common_Parameters/12_Note_Scale/ga/Play
0 /musicscale/Common_Parameters/12_Note_Scale/ga/Pluck
0 /musicscale/Common_Parameters/12_Note_Scale/ga/Starting_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/ga/Starting_Cent
2 /musicscale/Common_Parameters/12_Note_Scale/ga/Variance
0 /musicscale/Common_Parameters/12_Note_Scale/ma/0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/ma/Cent
0 /musicscale/Common_Parameters/12_Note_Scale/ma/Ending_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/ma/Ending_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/ma/Gamaka
3.5 /musicscale/Common_Parameters/12_Note_Scale/ma/Number
17 /musicscale/Common_Parameters/12_Note_Scale/ma/Rate
0 /musicscale/Common_Parameters/12_Note_Scale/ma/Play
0 /musicscale/Common_Parameters/12_Note_Scale/ma/Pluck
0 /musicscale/Common_Parameters/12_Note_Scale/ma/Starting_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/ma/Starting_Cent
2 /musicscale/Common_Parameters/12_Note_Scale/ma/Variance
0 /musicscale/Common_Parameters/12_Note_Scale/ni/0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/ni/Cent
0 /musicscale/Common_Parameters/12_Note_Scale/ni/Ending_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/ni/Ending_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/ni/Gamaka
3.5 /musicscale/Common_Parameters/12_Note_Scale/ni/Number
17 /musicscale/Common_Parameters/12_Note_Scale/ni/Rate
0 /musicscale/Common_Parameters/12_Note_Scale/ni/Play
0 /musicscale/Common_Parameters/12_Note_Scale/ni/Pluck
0 /musicscale/Common_Parameters/12_Note_Scale/ni/Starting_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/ni/Starting_Cent
2 /musicscale/Common_Parameters/12_Note_Scale/ni/Variance
0 /musicscale/Common_Parameters/12_Note_Scale/re/0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/re/Cent
0 /musicscale/Common_Parameters/12_Note_Scale/re/Ending_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/re/Ending_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/re/Gamaka
3.5 /musicscale/Common_Parameters/12_Note_Scale/re/Number
17 /musicscale/Common_Parameters/12_Note_Scale/re/Rate
0 /musicscale/Common_Parameters/12_Note_Scale/re/Play
0 /musicscale/Common_Parameters/12_Note_Scale/re/Pluck
0 /musicscale/Common_Parameters/12_Note_Scale/re/Starting_0.01_Cent
0 /musicscale/Common_Parameters/12_Note_Scale/re/Starting_Cent
2 /musicscale/Common_Parameters/12_Note_Scale/re/Variance
0 /musicscale/Common_Parameters/Fine_Tune
0 /musicscale/Common_Parameters/Octave
2 /musicscale/Common_Parameters/Period
3 /musicscale/Common_Parameters/Pitch
0 /musicscale/Zita_Light/Dry/Wet_Mix
-6.0 /musicscale/Zita_Light/Level`
let modelState = "tone"

const reset = () => {
    if(playState)
        playit()
    if(localStorage.getItem('musicscale'))
        localStorage.removeItem('musicscale')
    document.getElementById('startstop').disabled = false
    document.getElementById('startstop').classList.remove("disabled")
    playit()
}

const playit = () => {
    if(!playState) {
        playState = true
        initApp('musicscale')
        document.getElementById("startstop").innerHTML = "Pause Session"
        document.getElementById("getsnapshot").disabled = false
        document.getElementById('getsnapshot').classList.remove("disabled")
        document.getElementById("savesnapshot").disabled = false
        document.getElementById('savesnapshot').classList.remove("disabled")
        document.addEventListener("keydown",handlekey)
        document.addEventListener("keyup",handlekey)    
    } else {
        playState = false
        teardownApp('musicscale')
        document.getElementById("startstop").innerHTML = "Last Session"
        document.getElementById("getsnapshot").disabled = true
        document.getElementById('getsnapshot').classList.add("disabled")
        document.getElementById("savesnapshot").disabled = true
        document.getElementById('savesnapshot').classList.add("disabled")
        document.removeEventListener("keydown",handlekey)
        document.removeEventListener("keyup",handlekey)    
    }
}

const setModel = (model) => {
    let oldPlayState = playState
    if(oldPlayState)
        playit()
    if(model === "string") {
        window[dspName] = stringInstance
        modelState = "string"
    } else if(model === "tone") {
        window[dspName] = instance
        modelState = "tone"
    }
    if(oldPlayState)
        playit()
}

const handlekey = (e) => {
    let type = e.type
    let key = getNote(e.key)
    if(!key)
        return
    if(type === "keydown")
        keyplay(key)
    if(type === "keyup")
        keyrelease(key)
}

const getNote = (key) => {
    let notes = {a: "Sa", w: "re", s: "Re", e: "ga", d: "Ga", f: "ma", t: "Ma", g: "Pa", y: "dha", h: "Dha", u: "ni", j: "Ni", k: "SA"}
    return notes[key]
}

const keyplay = (key) => {dspNode.setParamValue(`/musicscale/Common_Parameters/12_Note_Scale/${key}/Pluck`,1)}

const keyrelease = (key) => {dspNode.setParamValue(`/musicscale/Common_Parameters/12_Note_Scale/${key}/Pluck`,0)}

const loadMusicScaleApp = () => {
    let appContainer = document.getElementById("musicscale")
    if(localStorage.getItem('musicscale')) {
        document.getElementById('startstop').disabled = false
        document.getElementById('startstop').classList.remove("disabled")
    }
  
    appContainer.insertAdjacentHTML('beforeend',getHTMLKeyboard())
    appContainer.insertAdjacentHTML('beforeend',getHTMLPitchUI())

    appContainer.insertAdjacentHTML('beforeend',getHTMLSlider('musicscale',"Cents","/musicscale/Common_Parameters/Fine_Tune",0,-100,100,1))
    appContainer.insertAdjacentHTML('beforeend',getHTMLSlider('musicscale',"Period","/musicscale/Common_Parameters/Period",2,0,3,0.1))
    appContainer.insertAdjacentHTML('beforeend',getHTMLSlider('musicscale',"Level","/musicscale/Zita_Light/Level",-6,-30,30,1))

    appContainer.insertAdjacentHTML('beforeend',getHTMLNoteTabs())

    clickNote("Sa button")
}

const getHTMLPitchUI = () => (`
    <h3>Common Parameters</h3>
    <span>Tone</span>
    <select class="field" name="model" id="model" oninput=setModel(this.value)>
        <option value="tone" selected>Synth</model>
        <option value="string">String</model>
    </select><br>
    <span>Key</span>
    <select class="field" name="pitch" id="/musicscale/Common_Parameters/Pitch" oninput=updateParams('musicscale',this.id,this.value)>
        <option value=14>B</option>
        <option value=13>A#</option>
        <option value=12>A</option>
        <option value=11 selected>G#</option>
        <option value=10>G</option>
        <option value=9>F#</option>
        <option value=8>F</option>
        <option value=7>E</option>
        <option value=6>D#</option>
        <option value=5>D</option>
        <option value=4>C#</option>
        <option value=3>C</option>
    </select><br>
    <span>Octave</span>
    <select class="field" name="octave" id="/musicscale/Common_Parameters/Octave" oninput=updateParams('musicscale',this.id,this.value)>
        <option value=1>High</option>
        <option value=0 selected>Medium</option>
        <option value=-1>Low</option>
        <option value=-2>Lowest</option>
    </select><br>
`)

const getHTMLKeyboard = () => {
    let notes = [
        {white: "Sa", black: "re"},
        {white: "Re", black: "ga"},
        {white: "Ga"},
        {white: "ma", black: "Ma"},
        {white: "Pa", black: "dha"},
        {white: "Dha", black: "ni"},
        {white: "Ni"},
        {white: "SA"},
    ]

    let keyb = {Sa: "a", re: "w", Re: "s", ga: "e", Ga: "d", ma:"f", Ma: "t", Pa: "g", dha: "y", Dha: "h", ni: "u", Ni: "j", SA: "k"}

    const getHTMLWhiteKey = (group) => (`
        <div class="key" onmousedown="keyplay('${group.white}')" onmouseup="keyrelease('${group.white}')" ontouchstart="keyplay('${group.white}')" ontouchend="keyrelease('${group.white}')">${group.white} (${keyb[group.white]})</div>
    `)

    const getHTMLBlackKey = (group) => {
        if(!group.black)
            return ""
        else
            return `<div class="blackkey" onmousedown="keyplay('${group.black}')" onmouseup="keyrelease('${group.black}')" ontouchstart="keyplay('${group.black}')" ontouchend="keyrelease('${group.black}')">${group.black} (${keyb[group.black]})</div>`
    }
    
    let HTMLKeyBoard = notes.map(group => (`
        <li>
            ${getHTMLWhiteKey(group)}
            ${getHTMLBlackKey(group)}
        </li>`)
    ).join('\n')

    return `<ul class="keyboard">
        ${HTMLKeyBoard}
    </ul><br>`
}

const getHTMLNoteTabs = () => {
    let notes = ["Sa", "re", "Re", "ga", "Ga", "ma", "Ma", "Pa", "dha", "Dha", "ni", "Ni", "SA"]

    const HTMLNoteLinks = notes.map((s) => getHTMLNoteLink(s)).join('\n')
    const HTMLNoteParams = notes.map((s) => getHTMLNoteParams(s)).join(`\n`)

    return `
    <br>
    <div id="notesettings" class="notetabs">
        ${HTMLNoteLinks}
    </div>
    ${HTMLNoteParams}
    `
}

const getHTMLNoteLink = (note) => (`
    <button class="stringlinks" id="${note} button" onclick="openNote(event, '${note}')">${note}</button>
`)

const getHTMLNoteParams = (note) => (`
    <div id="${note}" class="stringparams">
        <h3>${note} Parameters</h3>
        ${getHTMLToggle('musicscale',"Loop",`/musicscale/Common_Parameters/12_Note_Scale/${note}/Play`)}
        ${getHTMLSlider('musicscale',"Fine Tune",`/musicscale/Common_Parameters/12_Note_Scale/${note}/Cent`,0,-120,120,1)}
        ${getHTMLSlider('musicscale',"Ultrafine Tune",`/musicscale/Common_Parameters/12_Note_Scale/${note}/0.01_Cent`,0,-100,100,1)}
        ${getHTMLSlider('musicscale',"Variance",`/musicscale/Common_Parameters/12_Note_Scale/${note}/Variance`,2,0,4,0.1)}
        ${getHTMLNoteGamaka(note)}
    </div>
`)

const openNote = (evt, noteName) => {
    Array.from(document.getElementsByClassName("stringparams")).forEach(element => {element.style.display = "none"})
    Array.from(document.getElementsByClassName("stringlinks")).forEach(element => {element.classList.remove("active")})
    
    document.getElementById(noteName).style.display = "grid"
    evt.currentTarget.classList.add("active")
}

const clickNote = (note) => {
    document.getElementById(note).click()
}

const getHTMLNoteGamaka = (note) => {
    const HTMLGamakaLink = `<span>Gamaka </span><button class="timbrelinks" id="${note}/gamaka/link" onclick="toggleGamaka(event, '${note}')">Show Controls</button>`
    return `
    ${HTMLGamakaLink}
    <div id="${note}/gamaka" class="timbreparams">
        <br>
        ${getHTMLToggle('musicscale',"On/Off",`/musicscale/Common_Parameters/12_Note_Scale/${note}/Gamaka`)}
        ${getHTMLSlider('musicscale',"Starting Cents",`/musicscale/Common_Parameters/12_Note_Scale/${note}/Starting_Cent`,0,-220,220,1)}
        ${getHTMLSlider('musicscale',"Starting 0.01 Cents",`/musicscale/Common_Parameters/12_Note_Scale/${note}/Starting_0.01_Cent`,0,-100,100,1)}
        ${getHTMLSlider('musicscale',"Ending Cents",`/musicscale/Common_Parameters/12_Note_Scale/${note}/Ending_Cent`,0,-220,220,1)}
        ${getHTMLSlider('musicscale',"Ending 0.01 Cents",`/musicscale/Common_Parameters/12_Note_Scale/${note}/Ending_0.01_Cent`,0,-100,100,1)}
        ${getHTMLSlider('musicscale',"Rate",`/musicscale/Common_Parameters/12_Note_Scale/${note}/Rate`,10,-20,20,0.1)}
        ${getHTMLSlider('musicscale',"Number",`/musicscale/Common_Parameters/12_Note_Scale/${note}/Number`,3.5,0,10,0.01)}
    </div>
    `
}

const toggleGamaka = (evt, noteName) => {
    let link = evt.currentTarget
    let targetClassList = link.classList 
    let activeState = targetClassList.contains("active")
    let element = document.getElementById(`${noteName}/gamaka`)
    if(activeState) {
        link.innerHTML = "Show Controls"
        element.style.display = "none"
        targetClassList.remove("active")
    } else {
        link.innerHTML = "Hide Controls"
        element.style.display = "grid"
        targetClassList.add("active")
    }
}