let defaultParams = `0.0 /puretones/Zita_Light/Dry/Wet_Mix
0.0 /puretones/Zita_Light/Level
3.0 /puretones/PureTones_v1.0/0x00/Common_Frequency
0.0 /puretones/PureTones_v1.0/0x00/Octave_Selector
0.0 /puretones/PureTones_v1.0/0x00/Fine_Tune
6.0 /puretones/PureTones_v1.0/0x00/Period
5.0 /puretones/PureTones_v1.0/0x00/1st_String/Select_Note
0.0 /puretones/PureTones_v1.0/0x00/1st_String/Play_String/Once
1.0 /puretones/PureTones_v1.0/0x00/1st_String/Play_String/Loop
0.0 /puretones/PureTones_v1.0/0x00/1st_String/Fine_Tune
0.0 /puretones/PureTones_v1.0/0x00/1st_String/Ultrafine_Tune
5.0 /puretones/PureTones_v1.0/0x00/1st_String/Variance
0.0 /puretones/PureTones_v1.0/0x00/1st_String/Gain
5.6 /puretones/PureTones_v1.0/0x00/1st_String/Octave_1
7.8 /puretones/PureTones_v1.0/0x00/1st_String/Octave_2
5.6 /puretones/PureTones_v1.0/0x00/1st_String/Octave_3
1.0 /puretones/PureTones_v1.0/0x00/1st_String/Octave_4
0.4 /puretones/PureTones_v1.0/0x00/1st_String/Octave_5
0.2 /puretones/PureTones_v1.0/0x00/1st_String/Octave_6
0.0 /puretones/PureTones_v1.0/0x00/2nd_String/Select_Note
0.0 /puretones/PureTones_v1.0/0x00/2nd_String/Play_String/Once
1.0 /puretones/PureTones_v1.0/0x00/2nd_String/Play_String/Loop
0.0 /puretones/PureTones_v1.0/0x00/2nd_String/Fine_Tune
0.0 /puretones/PureTones_v1.0/0x00/2nd_String/Ultrafine_Tune
5.0 /puretones/PureTones_v1.0/0x00/2nd_String/Variance
0.0 /puretones/PureTones_v1.0/0x00/2nd_String/Gain
5.6 /puretones/PureTones_v1.0/0x00/2nd_String/Octave_1
7.8 /puretones/PureTones_v1.0/0x00/2nd_String/Octave_2
5.6 /puretones/PureTones_v1.0/0x00/2nd_String/Octave_3
1.0 /puretones/PureTones_v1.0/0x00/2nd_String/Octave_4
0.4 /puretones/PureTones_v1.0/0x00/2nd_String/Octave_5
0.2 /puretones/PureTones_v1.0/0x00/2nd_String/Octave_6
12.0 /puretones/PureTones_v1.0/0x00/3rd_String/Select_Note
0.0 /puretones/PureTones_v1.0/0x00/3rd_String/Play_String/Once
1.0 /puretones/PureTones_v1.0/0x00/3rd_String/Play_String/Loop
0.0 /puretones/PureTones_v1.0/0x00/3rd_String/Fine_Tune
0.0 /puretones/PureTones_v1.0/0x00/3rd_String/Ultrafine_Tune
5.0 /puretones/PureTones_v1.0/0x00/3rd_String/Variance
0.0 /puretones/PureTones_v1.0/0x00/3rd_String/Gain
5.6 /puretones/PureTones_v1.0/0x00/3rd_String/Octave_1
7.8 /puretones/PureTones_v1.0/0x00/3rd_String/Octave_2
5.6 /puretones/PureTones_v1.0/0x00/3rd_String/Octave_3
1.0 /puretones/PureTones_v1.0/0x00/3rd_String/Octave_4
0.4 /puretones/PureTones_v1.0/0x00/3rd_String/Octave_5
0.2 /puretones/PureTones_v1.0/0x00/3rd_String/Octave_6
5.0 /puretones/PureTones_v1.0/0x00/4th_String/Select_Note
0.0 /puretones/PureTones_v1.0/0x00/4th_String/Play_String/Once
1.0 /puretones/PureTones_v1.0/0x00/4th_String/Play_String/Loop
0.0 /puretones/PureTones_v1.0/0x00/4th_String/Fine_Tune
0.0 /puretones/PureTones_v1.0/0x00/4th_String/Ultrafine_Tune
5.0 /puretones/PureTones_v1.0/0x00/4th_String/Variance
0.0 /puretones/PureTones_v1.0/0x00/4th_String/Gain
5.6 /puretones/PureTones_v1.0/0x00/4th_String/Octave_1
7.8 /puretones/PureTones_v1.0/0x00/4th_String/Octave_2
5.6 /puretones/PureTones_v1.0/0x00/4th_String/Octave_3
1.0 /puretones/PureTones_v1.0/0x00/4th_String/Octave_4
0.4 /puretones/PureTones_v1.0/0x00/4th_String/Octave_5
0.2 /puretones/PureTones_v1.0/0x00/4th_String/Octave_6
0.0 /puretones/PureTones_v1.0/0x00/5th_String/Select_Note
0.0 /puretones/PureTones_v1.0/0x00/5th_String/Play_String/Once
1.0 /puretones/PureTones_v1.0/0x00/5th_String/Play_String/Loop
0.0 /puretones/PureTones_v1.0/0x00/5th_String/Fine_Tune
0.0 /puretones/PureTones_v1.0/0x00/5th_String/Ultrafine_Tune
5.0 /puretones/PureTones_v1.0/0x00/5th_String/Variance
0.0 /puretones/PureTones_v1.0/0x00/5th_String/Gain
5.6 /puretones/PureTones_v1.0/0x00/5th_String/Octave_1
7.8 /puretones/PureTones_v1.0/0x00/5th_String/Octave_2
5.6 /puretones/PureTones_v1.0/0x00/5th_String/Octave_3
1.0 /puretones/PureTones_v1.0/0x00/5th_String/Octave_4
0.4 /puretones/PureTones_v1.0/0x00/5th_String/Octave_5
0.2 /puretones/PureTones_v1.0/0x00/5th_String/Octave_6
12.0 /puretones/PureTones_v1.0/0x00/6th_String/Select_Note
0.0 /puretones/PureTones_v1.0/0x00/6th_String/Play_String/Once
1.0 /puretones/PureTones_v1.0/0x00/6th_String/Play_String/Loop
0.0 /puretones/PureTones_v1.0/0x00/6th_String/Fine_Tune
0.0 /puretones/PureTones_v1.0/0x00/6th_String/Ultrafine_Tune
5.0 /puretones/PureTones_v1.0/0x00/6th_String/Variance
0.0 /puretones/PureTones_v1.0/0x00/6th_String/Gain
5.6 /puretones/PureTones_v1.0/0x00/6th_String/Octave_1
7.8 /puretones/PureTones_v1.0/0x00/6th_String/Octave_2
5.6 /puretones/PureTones_v1.0/0x00/6th_String/Octave_3
1.0 /puretones/PureTones_v1.0/0x00/6th_String/Octave_4
0.4 /puretones/PureTones_v1.0/0x00/6th_String/Octave_5
0.2 /puretones/PureTones_v1.0/0x00/6th_String/Octave_6`

const reset = () => {
    localStorage.clear()
    document.getElementById('playstop').disabled = false
    playit()
}

const playit = () => {
    if(!playState) {
        playState = true
        initApp('puretones')
        document.getElementById("playstop").innerHTML = "Pause Session"
        document.getElementById("getsnapshot").disabled = false
        document.getElementById('getsnapshot').classList.remove("disabled")
        document.getElementById("savesnapshot").disabled = false
        document.getElementById('savesnapshot').classList.remove("disabled")
    } else {
        playState = false
        teardownApp('puretones')
        document.getElementById("playstop").innerHTML = "Last Session"
        document.getElementById("getsnapshot").disabled = true
        document.getElementById('getsnapshot').classList.add("disabled")
        document.getElementById("savesnapshot").disabled = true
        document.getElementById('savesnapshot').classList.add("disabled")
    }
}

const loadPureTonesApp = () => {
    let appContainer = document.getElementById("puretones")
    if(localStorage.getItem('puretones')) {
        document.getElementById('playstop').disabled = false
        document.getElementById('playstop').classList.remove('disabled')
    }

    appContainer.insertAdjacentHTML('beforeend',getHTMLPitchUI())

    appContainer.insertAdjacentHTML('beforeend',getHTMLSlider('puretones',"Cents","/puretones/PureTones_v1.0/0x00/Fine_Tune",0,-100,100,1))
    appContainer.insertAdjacentHTML('beforeend',getHTMLSlider('puretones',"Period","/puretones/Zita_Light/Period",7,4,10,0.5))
    appContainer.insertAdjacentHTML('beforeend',getHTMLSlider('puretones',"Level","/puretones/Zita_Light/Level",0,-30,30,1))

    appContainer.insertAdjacentHTML('beforeend',getHTMLStringTabs())

    clickString("1st String button")

}

const getHTMLPitchUI = () => (`
    <h3>Common Parameters</h3>
    <span>Key</span>
    <select class="field" name="pitch" id="/puretones/PureTones_v1.0/0x00/Common_Frequency" oninput=updateParams('puretones',this.id,this.value)>
        <option value=14>B</option>
        <option value=13>A#</option>
        <option value=12>A</option>
        <option value=11 selected>G#</option>
        <option value=10>G</option>
        <option value=9>F#</option>
        <option value=8>F</option>
        <option value=7>E</option>
        <option value=6>D#</option>
        <option value=5>D</option>
        <option value=4>C#</option>
        <option value=3>C</option>
    </select><br>
    <span>Octave</span>
    <select class="field" name="octave" id="/puretones/PureTones_v1.0/0x00/Octave_Selector" oninput=updateParams('puretones',this.id,this.value)>
        <option value=1>High</option>
        <option value=0 selected>Medium</option>
        <option value=-1>Low</option>
    </select><br>
`)

const getHTMLStringTabs = () => {
    let strings = ["1st String", "2nd String", "3rd String", "4th String", "5th String", "6th String"]

    const HTMLStringLinks = strings.map((s) => getHTMLStringLink(s)).join('\n')
    const HTMLStringParams = strings.map((s) => getHTMLStringParams(s)).join(`\n`)

    return `
    <br>
    <div id="stringsettings" class="stringtabs">
        ${HTMLStringLinks}
    </div>
    ${HTMLStringParams}
    `
}

const getHTMLStringLink = (string) => (`
    <button class="stringlinks" id="${string} button" onclick="openString(event, '${string}')">${string}</button>
`)

const getHTMLStringParams = (string) => (`
    <div id="${string}" class="stringparams">
        <h3>${string} Parameters</h3>
        ${getHTMLToggle('puretones',"Loop",`/puretones/PureTones_v1.0/0x00/${string.replace(" ","_")}/Play_String/Loop`)}
        ${getHTMLStringNoteUI(string)}
        ${getHTMLSlider('puretones',"Fine Tune",`/puretones/PureTones_v1.0/0x00/${string.replace(" ","_")}/Fine_Tune`,0,-100,100,1)}
        ${getHTMLSlider('puretones',"Ultrafine Tune",`/puretones/PureTones_v1.0/0x00/${string.replace(" ","_")}/Ultrafine_Tune`,0,-100,100,1)}
        ${getHTMLSlider('puretones',"Variance",`/puretones/PureTones_v1.0/0x00/${string.replace(" ","_")}/Variance`,5,0,10,0.1)}
        ${getHTMLSlider('puretones',"Gain",`/puretones/PureTones_v1.0/0x00/${string.replace(" ","_")}/Gain`,0,-20,20,0.1)}
        ${getHTMLStringTimbre(string)}
    </div>
`)

const openString = (evt, stringName) => {
    Array.from(document.getElementsByClassName("stringparams")).forEach(element => {element.style.display = "none"})
    Array.from(document.getElementsByClassName("stringlinks")).forEach(element => {element.classList.remove("active")})
    
    document.getElementById(stringName).style.display = "grid"
    evt.currentTarget.classList.add("active")
}

const clickString = (string) => {
    document.getElementById(string).click()
}

const getHTMLStringNoteUI = (string) => (`
    <span>Note</span>
    <select class="field" name="note${string}" id="/puretones/PureTones_v1.0/0x00/${string.replace(" ","_")}/Select_Note" oninput=updateParams('puretones',this.id,this.value)>
        <option value=0>SA</option>
        <option value=1>Ni</option>
        <option value=2>ni</option>
        <option value=3>Dha</option>
        <option value=4>dha</option>
        <option value=5>Pa</option>
        <option value=6>Ma</option>
        <option value=7>ma</option>
        <option value=8>Ga</option>
        <option value=9>ga</option>
        <option value=10>Re</option>
        <option value=11>re</option>
        <option value=12>Sa</option>
    </select><br>
`)

const getHTMLStringTimbre = (string) => {
    let octaves = ["Octave 1", "Octave 2", "Octave 3", "Octave 4", "Octave 5", "Octave 6"]
    const HTMLStringTimbre = octaves.map((o) => getHTMLSlider('puretones',o,`/puretones/PureTones_v1.0/0x00/${string.replace(" ","_")}/${o.replace(" ","_")}`,5,0,10,0.1)).join('\n')
    const HTMLTimbreLink = `<span>Timbre </span><button class="timbrelinks" id="${string}/timbre/link" onclick="toggleTimbre(event, '${string}')">Show Controls</button>`
    return `
    ${HTMLTimbreLink}
    <div id="${string}/timbre" class="timbreparams">
        <br>
        ${HTMLStringTimbre}
    </div>
    `
}

const toggleTimbre = (evt, stringName) => {
    let link = evt.currentTarget
    let targetClassList = link.classList 
    let activeState = targetClassList.contains("active")
    let element = document.getElementById(`${stringName}/timbre`)
    if(activeState) {
        link.innerHTML = "Show Controls"
        element.style.display = "none"
        targetClassList.remove("active")
    } else {
        link.innerHTML = "Hide Controls"
        element.style.display = "grid"
        targetClassList.add("active")
    }
}